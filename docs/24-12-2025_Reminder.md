# Deadline & Reminder System - TickTick-Style Unified Popover

## Summary

The user wants a **TickTick-style unified date/time/reminder popover** instead of the current separate popover approach. This is a significant UX redesign.

**Current state:** Separate DeadlinePicker and ReminderSelector popovers
**Target state:** Single unified popover with Date/Time/Reminder sections inline

---

## Backend Status (Complete)

| Component | Status | File |
|-----------|--------|------|
| Database migration (JSONB `reminders` column) | âœ… | `backend/alembic/versions/fc2d66d95b01_...` |
| Task model with `reminders` column | âœ… | `backend/app/models/task.py:80` |
| API schemas with validation | âœ… | `backend/app/api/tasks.py` |
| Backend is complete - no changes needed | âœ… | - |

---

## Frontend Gaps (6 Items)

### Gap 1: Unified Date/Time/Reminder Popover
**Priority:** High | **Impact:** Major UX improvement

**Current:** Two separate popovers (DeadlinePicker + ReminderSelector)
**Target:** Single popover like TickTick with inline sections

### Gap 2: Smart Date Labels
**Priority:** High | **Impact:** UX polish

**Current:** Shows full date format
**Target:** "Today", "Tomorrow", date label + time suffix when time is set

### Gap 3: TaskCard Still Displays Old `reminder_time`
**File:** `frontend/components/TaskCard.tsx:261-265`
**Fix:** Update to display `reminders[]` array

### Gap 4: AI Suggestion Handling Uses Old Field
**File:** `frontend/components/TaskDetailPopover.tsx:319, 345-346`
**Fix:** Convert `reminder_time` suggestions to `reminders[]` array

### Gap 5: SuggestionPanel Missing `reminders` Formatter
**File:** `frontend/components/SuggestionPanel.tsx:68-69`
**Fix:** Add case for `reminders` array formatting

### Gap 6: All-Day Toggle Integration
**Priority:** Medium | **Impact:** UX consistency
**Fix:** All-day toggle should be inside unified popover, not separate

---

## Implementation Plan

### Phase 1: Create UnifiedDatePicker Component (New)
**File:** `frontend/components/UnifiedDatePicker.tsx`

A new component that combines calendar, time, reminders, and all-day toggle in one popover.

**Props:**
```typescript
interface UnifiedDatePickerProps {
  // Date/time
  value?: string | null           // ISO datetime
  onChange: (date: string | null) => void

  // All-day flag
  allDay?: boolean
  onAllDayChange?: (allDay: boolean) => void

  // Reminders
  reminders?: number[]
  onRemindersChange?: (reminders: number[]) => void

  // Optional
  placeholder?: string
  disabled?: boolean
}
```

**UI Structure (matching TickTick):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       September 2025            â”‚
â”‚  S  M  T  W  T  F  S            â”‚
â”‚  ...calendar...                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ• Time                    [>] â”‚ â† Collapsible (click to expand)
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   Expanded shows:
â”‚     â”‚ [HH:MM] input          â”‚  â”‚   - Time input
â”‚     â”‚ [Morning] [Afternoon]  â”‚  â”‚   - Preset buttons
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ”” Reminder                [>] â”‚ â† Collapsible (click to expand)
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   Expanded shows:
â”‚     â”‚ â˜‘ On time              â”‚  â”‚   - Checkbox presets
â”‚     â”‚ â˜ 5 minutes early      â”‚  â”‚   - Custom option
â”‚     â”‚ â˜‘ 30 minutes early     â”‚  â”‚
â”‚     â”‚ â˜ 1 hour early         â”‚  â”‚
â”‚     â”‚ â˜ Custom               â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  All Day                   [â¬œ] â”‚ â† Toggle switch row
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ Clear ]         [ OK ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Section Behavior:**
- Time and Reminder are collapsible sections (collapsed by default)
- Click row to expand/collapse
- When expanded, show full options
- Chevron rotates to indicate state (> collapsed, v expanded)
- Summary text shown when collapsed (e.g., "09:00", "2 reminders")

**Display Button (smart labels):**
- No date: "Set due date"
- Today: "Today" or "Today, 09:00"
- Tomorrow: "Tomorrow" or "Tomorrow, 14:00"
- Other: "Dec 25" or "Dec 25, 09:00"
- With reminders: Show ðŸ”” icon

---

### Phase 2: Smart Date Formatting Utility
**File:** `frontend/lib/dateUtils.ts` (new or update existing)

```typescript
export function formatSmartDate(date: string | null, includeTime: boolean): string {
  if (!date) return ''

  const d = new Date(date)
  const today = new Date()
  const tomorrow = new Date(today)
  tomorrow.setDate(tomorrow.getDate() + 1)

  let dateStr: string
  if (isSameDay(d, today)) {
    dateStr = 'Today'
  } else if (isSameDay(d, tomorrow)) {
    dateStr = 'Tomorrow'
  } else {
    dateStr = format(d, 'MMM d')  // "Dec 25"
  }

  if (includeTime && hasTime(date)) {
    return `${dateStr}, ${format(d, 'HH:mm')}`
  }
  return dateStr
}
```

---

### Phase 3: Update TaskDetailPopover Integration
**File:** `frontend/components/TaskDetailPopover.tsx`

Replace separate DeadlinePicker + ReminderSelector with UnifiedDatePicker:

**Before (lines 516-542):**
```tsx
<DeadlinePicker ... />
<DatePickerWithOptionalTime ... />  // start_date
<ReminderSelector ... />
```

**After:**
```tsx
<UnifiedDatePicker
  value={localTask.due_date}
  onChange={(date) => handleFieldChange("due_date", date, true)}
  allDay={localTask.all_day || false}
  onAllDayChange={(allDay) => handleFieldChange("all_day", allDay, true)}
  reminders={localTask.reminders || []}
  onRemindersChange={(reminders) => handleFieldChange("reminders", reminders, true)}
/>
<DatePickerWithOptionalTime ... />  // start_date (keep separate)
```

---

### Phase 4: Update QuickAddTaskModal Integration
**File:** `frontend/components/QuickAddTaskModal.tsx`

Replace separate components with UnifiedDatePicker (same component as TaskDetailPopover for consistency).

**Current (separate components):**
```tsx
<MetadataRow icon="ðŸ“…" label="Due Date">
  <DeadlinePicker ... />
</MetadataRow>
<MetadataRow icon="ðŸ””" label="Reminder">
  <ReminderSelector ... />
</MetadataRow>
```

**After (unified):**
```tsx
<MetadataRow icon="ðŸ“…" label="Due Date">
  <UnifiedDatePicker
    value={dueDate}
    onChange={setDueDate}
    allDay={allDay}
    onAllDayChange={setAllDay}
    reminders={reminders}
    onRemindersChange={setReminders}
  />
</MetadataRow>
{/* Remove separate Reminder row - now integrated */}
```

---

### Phase 5: Fix Migration Gaps

#### 5a. TaskCard Reminder Display
**File:** `frontend/components/TaskCard.tsx:261-265`

```tsx
{/* Display reminders from new array */}
{task.reminders && task.reminders.length > 0 && (
  <Badge variant="outline" className="text-xs">
    ðŸ”” {task.reminders.length === 1
      ? formatReminderMinutes(task.reminders[0], task.all_day)
      : `${task.reminders.length} reminders`}
  </Badge>
)}
{/* Fallback for old data */}
{!task.reminders?.length && task.reminder_time && (
  <Badge variant="outline" className="text-xs">
    ðŸ”” {formatSmartDate(task.reminder_time, true)}
  </Badge>
)}
```

#### 5b. AI Suggestion Handling
**File:** `frontend/components/TaskDetailPopover.tsx:319, 345-346`

Convert `reminder_time` suggestions to `reminders[]` array format.

#### 5c. SuggestionPanel Formatter
**File:** `frontend/components/SuggestionPanel.tsx:68-69`

Add case for `reminders` array.

---

## Files to Create/Modify

### New Files
1. `frontend/components/UnifiedDatePicker.tsx` - Main unified component

### Modified Files
1. `frontend/components/TaskDetailPopover.tsx` - Replace separate pickers with unified
2. `frontend/components/QuickAddTaskModal.tsx` - Replace separate pickers with unified
3. `frontend/components/TaskCard.tsx:261-265` - Update reminder display
4. `frontend/components/SuggestionPanel.tsx:68-69` - Add reminders formatter
5. `frontend/lib/dateUtils.ts` - Add smart date formatting (if not exists)

### Files to Keep (No Changes)
- `frontend/components/DeadlinePicker.tsx` - Keep for reference/gradual migration
- `frontend/components/ReminderSelector.tsx` - Inline logic into UnifiedDatePicker
- `frontend/components/DatePickerWithOptionalTime.tsx` - Keep for start_date

---

## Testing Checklist

- [ ] UnifiedDatePicker opens single popover with all sections
- [ ] Calendar date selection works
- [ ] Time section expands and allows time input
- [ ] Reminder section expands with checkbox presets
- [ ] All-day toggle switches preset options
- [ ] Smart date labels show "Today", "Tomorrow", etc.
- [ ] Time suffix shows when time is set
- [ ] Reminders persist after selection and save
- [ ] TaskCard shows reminders array correctly
- [ ] AI suggestions convert to reminders array
- [ ] Start date remains separate DatePickerWithOptionalTime

---

## Dependencies

- shadcn/ui components: Calendar, Popover, Checkbox, Switch, Button
- date-fns for formatting
- Existing patterns from DatePickerWithOptionalTime and ReminderSelector
