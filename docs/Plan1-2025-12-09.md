# Context Task Management - Incremental Implementation Plan

## Current Status (2025-12-10)

**Phase 3 Complete! ðŸŽ‰** The application now has a fully functional task management interface with:
- âœ… **60 real tasks** synced from TickTick and analyzed with AI
- âœ… **Dual view system**: Toggle between Eisenhower Matrix and List views
- âœ… **Interactive Matrix**: 2x2 grid with clickable task popovers
- âœ… **Smart filtering**: Quadrant-based task organization (Q1: 16, Q2: 24, Q3: 2, Q4: 18)
- âœ… **AI-powered insights**: Each task has urgency/importance scores + reasoning

**Tech Stack:**
- Backend: FastAPI + PostgreSQL + Ollama (qwen3:4b)
- Frontend: Next.js 14 + TypeScript + Tailwind + shadcn/ui
- AI: Local LLM via Ollama for task analysis

**Quick Start:**
```bash
./init.sh start all          # Start all services
open http://localhost:3000   # View the app
```

---

## Philosophy: Feedback-Driven, Speed Over Perfection

**Core Principle:** Get something working ASAP, then iterate based on real usage.

**Approach:** Ollama endpoint â†’ Test it works â†’ Add UI â†’ Add TickTick â†’ Get feedback â†’ Iterate

---

## Configuration Decisions

| Setting | Choice | Rationale |
|---------|--------|-----------|
| **Ollama Model** | `qwen3:4b` (fast) / `qwen3:8b` (accurate) | Already installed, good at tool calls |
| **TickTick** | Real credentials ready | Client ID + Secret available |
| **Settings Storage** | localStorage (frontend) | Simple, no backend persistence needed initially |
| **Database** | PostgreSQL via Docker | Easy to host later, production-ready |
| **Dev Environment** | Docker for DB, local for app | Fast iteration with proper DB |

---

## Iteration 0: Minimal Viable Demo (2-3 hours)

**Goal:** Prove Ollama (qwen3) can analyze a task description via FastAPI endpoint

**Demo:** POST request with task text â†’ get back urgency/importance/quadrant scores

**Status:** âœ… **COMPLETED** (FastAPI `POST /api/analyze` + Ollama `qwen3` responding)

**Additional infrastructure completed:**
- âœ… PostgreSQL + Redis running via Docker (port 5433 to avoid local conflict)
- âœ… Database models created (User, Task, Settings) with SQLAlchemy
- âœ… Alembic migrations configured and applied
- âœ… Core configuration system with Pydantic Settings
- âœ… Database connection test scripts created

**Completed deliverables:**
- [x] FastAPI service running locally with `/health` and `/api/analyze`
- [x] Ollama reachable at `http://localhost:11434` with `qwen3` model
- [x] Quadrant calculation returned in JSON

**Quick verification:**
```bash
curl -s http://localhost:8000/health
curl -s -X POST http://localhost:8000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{"description": "Finish quarterly report by Friday"}'
```

### Files to Create

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                    # FastAPI app with ONE endpoint
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ llm_ollama.py          # Ollama client
â”œâ”€â”€ requirements.txt
â””â”€â”€ .env.example
docker-compose.yml                  # PostgreSQL + Redis
```

### Dependencies (requirements.txt)
```
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0
pydantic-settings==2.1.0
httpx==0.25.2
python-dotenv==1.0.0
sqlalchemy[asyncio]==2.0.23
asyncpg==0.29.0
alembic==1.13.0
```

### Docker Compose (docker-compose.yml)
```yaml
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: context
      POSTGRES_PASSWORD: context_dev
      POSTGRES_DB: context
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

volumes:
  postgres_data:
```

### Key Implementation Details

**Ollama Service (`llm_ollama.py`):**
- Connect to `http://localhost:11434`
- Default model: `qwen3:4b` (configurable to `qwen3:8b`)
- Use `/api/generate` endpoint with `format: "json"`
- Prompt returns: `{urgency: 1-10, importance: 1-10, reasoning: string}`
- Calculate quadrant: Q1 (Uâ‰¥7, Iâ‰¥7), Q2 (U<7, Iâ‰¥7), Q3 (Uâ‰¥7, I<7), Q4 (both <7)

**FastAPI Endpoint (`main.py`):**
- `POST /api/analyze` - Accepts task description, returns analysis
- `GET /health` - Health check
- CORS enabled for frontend

### What's Deferred
- Database (use in-memory)
- Authentication
- Background jobs
- Frontend
- TickTick integration

### Success Criteria
- FastAPI starts without errors
- Ollama responds within 5-10 seconds
- Quadrant assignment makes sense
- Can test via curl/Postman

---

## Iteration 1: Basic UI + Settings (3-4 hours)

**Goal:** Simple web page to test task analysis and configure LLM settings

**Demo:** Type a task in a form â†’ see analysis instantly â†’ configure Ollama URL

**Status:** âœ… **COMPLETED** (2025-12-10 - Fully tested and working)

**Completed Work (2025-12-10):**
- âœ… Backend infrastructure: PostgreSQL on port 5433, Redis, Alembic migrations
- âœ… Database models: User, Task, Settings with proper relationships
- âœ… API routers: Full CRUD for tasks + settings endpoints
- âœ… FastAPI integration: Routers added to main.py with CORS
- âœ… Next.js 14 frontend: TypeScript + Tailwind + shadcn/ui
- âœ… TaskAnalyzer component: AI-powered task analysis with quadrant display
- âœ… LLMSettings component: Redesigned with model selector (removed confusing URL field)
- âœ… Tabbed UI: Analyze Task | Settings (replaced static welcome page)
- âœ… API client: Backend integration with error handling

**Critical Bugs Fixed (2025-12-10):**
1. **Frontend/Backend field mismatch:**
   - Fixed TaskAnalyzer sending `task_description` instead of `description`
   - Fixed backend response fields: `urgency_score`, `importance_score`, `eisenhower_quadrant`
2. **Settings UI misleading architecture:**
   - Removed editable "Ollama Provider URL" field (was unused)
   - Made Backend URL read-only: `http://127.0.0.1:8000`
   - Added model selector dropdown (qwen3:4b / qwen3:8b)
   - Added "Architecture Overview" card explaining request flow
   - Fixed connection status check (`healthy` â†’ `ok`)

**Testing Status:**
- âœ… Backend endpoints: `/health`, `/api/analyze`, `/api/llm/health`, `/api/llm/models` verified
- âœ… Frontend build: Successful compilation, no errors
- âœ… End-to-end testing: **COMPLETE** via Playwright
- âœ… Task analysis: Working with Ollama qwen3:4b (Q1, Q2, Q4 quadrants tested)
- âœ… Settings tab: Connection testing, model selection, localStorage persistence working
- âœ… No console errors, all API calls returning 200 OK

**Architecture Validated:**
- Frontend (localhost:3000) â†’ Backend (127.0.0.1:8000) â†’ Ollama (127.0.0.1:11434)
- Frontend NEVER communicates directly with Ollama (security/flexibility)
- All LLM requests proxied through backend FastAPI service

**Ready for Phase 2: TickTick OAuth Integration**

**Current Todo List (2025-12-10):**
- âœ… Phase 1: Replace page.tsx with tabbed interface (Analyze | Settings)
- âœ… Phase 1: Test tabbed UI and manual task analysis
- âœ… Phase 1: Fix Settings UI - remove URL field, add model selector
- â­ï¸ Phase 2: Create TickTick service (backend/app/services/ticktick.py)
- â­ï¸ Phase 2: Create auth router (backend/app/api/auth.py)
- â­ï¸ Phase 2: Register auth router in main.py
- â­ï¸ Phase 2: Add sync endpoint to tasks.py
- â­ï¸ Phase 3: Create OAuth callback page (frontend/app/auth/callback/page.tsx)
- â­ï¸ Phase 3: Add TickTick connection UI to Settings tab
- â­ï¸ Phase 3: Add sync UI to Analyze tab
- â­ï¸ Phase 4: End-to-end testing with Playwright

**Validation Complete:**
- âœ… `npm install && npm run dev` in `frontend/` loads `http://localhost:3000`
- âœ… Analyze form returns urgency/importance/quadrant for sample tasks
- âœ… Settings model selection persists in localStorage
- âœ… Clear error messages when Ollama/backend unreachable
- âœ… Backend URL standardized to `http://127.0.0.1:8000`
- âœ… Zero console errors during tab navigation and API calls

### Files to Create

```
frontend/
â”œâ”€â”€ package.json
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â”œâ”€â”€ page.tsx              # Main page with tabs
â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â””â”€â”€ settings/
â”‚   â”‚       â””â”€â”€ page.tsx          # Settings page
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ TaskAnalyzer.tsx      # Form + results display
â”‚   â”‚   â””â”€â”€ LLMSettings.tsx       # Provider configuration
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ api.ts                # Backend API client
```

### Frontend Stack
- Next.js 14 (App Router)
- TypeScript
- Tailwind CSS
- shadcn/ui components (Button, Input, Card, Select)

### Key Components

**TaskAnalyzer.tsx:**
- Textarea for task description
- "Analyze" button
- Results display: urgency, importance, quadrant, reasoning
- Loading state

**LLMSettings.tsx:** (Redesigned 2025-12-10)
- Read-only Backend URL display (`http://127.0.0.1:8000`)
- Model selector dropdown (qwen3:4b, qwen3:8b)
- "Test Connection" button (tests backend â†’ Ollama connectivity)
- "Save Settings" button (persists model choice to localStorage)
- Connection status card (green/red/blue with detailed messages)
- Architecture Overview card (explains Frontend â†’ Backend â†’ Ollama flow)
- Note: Removed editable "Ollama URL" field to prevent confusion (backend handles this)

### Backend Addition
- `GET /api/llm/health` - Check if Ollama is reachable
- `GET /api/llm/models` - List available Ollama models

### What's Deferred
- Task persistence
- User authentication
- TickTick integration

### Success Criteria - âœ… ALL MET (2025-12-10)
- âœ… Can type task and see analysis (Q1, Q2, Q4 quadrants verified)
- âœ… Model selection persists in localStorage across browser refresh
- âœ… Clear error messages when Ollama/backend unavailable
- âœ… Tabbed interface working (Analyze | Settings)
- âœ… Backend URL clearly displayed (`http://127.0.0.1:8000`)
- âœ… Architecture flow clearly explained to users
- âœ… Zero console errors during normal operation
- âœ… All API endpoints returning proper responses (200 OK)

**Files Modified (2025-12-10):**
- `frontend/app/page.tsx` - Replaced static welcome with tabbed interface
- `frontend/components/TaskAnalyzer.tsx` - Fixed API field name (`description`)
- `frontend/components/LLMSettings.tsx` - Complete redesign (removed URL field, added model selector)
- `backend/app/main.py` - Fixed response field names (`urgency_score`, `importance_score`, `eisenhower_quadrant`)
- `frontend/components/ui/alert.tsx` - Added via shadcn CLI

---

## Iteration 2: TickTick Integration (4-5 hours)

**Goal:** Fetch real tasks from TickTick, analyze them, display in a list

**Demo:** Click "Sync" â†’ see actual TickTick tasks with quadrant assignments

**Status:** âœ… **COMPLETED** (2025-12-10 - Fully functional with real TickTick account)

**Completed Work (2025-12-10):**

### Backend Implementation
- âœ… **TickTick service** (`backend/app/services/ticktick.py`):
  - OAuth2 authorization URL generation
  - Token exchange and refresh
  - Task fetching from TickTick API (all projects)
  - User info retrieval
  - Token storage with database integration
- âœ… **Auth router** (`backend/app/api/auth.py`):
  - `GET /auth/ticktick/authorize` - Redirect to TickTick OAuth
  - `GET /auth/ticktick/callback` - Handle OAuth callback with comprehensive error handling
  - `POST /auth/ticktick/disconnect` - Clear stored tokens
  - `GET /auth/ticktick/status` - Check connection status
  - `GET /auth/ticktick/debug` - Debug endpoint for OAuth config verification
- âœ… **Sync endpoint** (`backend/app/api/tasks.py`):
  - `POST /api/tasks/sync` - Fetch tasks from TickTick, analyze with LLM, store in database
  - Returns detailed sync statistics (synced, analyzed, failed counts)
  - Handles existing task updates and new task creation
  - Skips completed tasks (status=2 in TickTick)

### Frontend Implementation
- âœ… **OAuth callback page** (`frontend/app/auth/callback/page.tsx`):
  - Success/error message display
  - Auto-redirect to home after 3 seconds
  - Manual redirect link
  - React Router warning fixes
- âœ… **Settings tab** (`frontend/components/LLMSettings.tsx`):
  - TickTick Integration card
  - Connection status display (Connected/Not Connected)
  - Connect/Disconnect buttons
  - TickTick user ID display when connected
  - Status check on component mount
- âœ… **Analyze tab** (`frontend/components/TaskAnalyzer.tsx`):
  - Sync TickTick Tasks button with loading state
  - Detailed sync results (synced, analyzed, failed counts)
  - Error handling with clear user messages
  - Phase 1 manual analysis functionality preserved

### Production Testing Results
- âœ… **OAuth flow**: Successfully connects to real TickTick account
- âœ… **Token exchange**: Access and refresh tokens stored in database
- âœ… **Task sync**: **60 tasks synced** from real TickTick account
- âœ… **LLM analysis**: All 60 tasks analyzed with urgency/importance/quadrant
- âœ… **Database storage**: Tasks persisted with TickTick metadata
- âœ… **Zero errors**: 0 failed syncs
- âœ… **End-to-end**: Complete OAuth flow tested via Playwright

### Issues Resolved (2025-12-10)
1. **Redirect URI mismatch**: Fixed path from `/api/auth/ticktick/callback` to `/auth/ticktick/callback`
2. **URL standardization**: Changed all URLs from `127.0.0.1:8000` to `localhost:8000`
3. **Database integrity**: Added default email for User creation (`user{id}@ticktick.local`)
4. **React warnings**: Fixed setState during render in OAuth callback page
5. **CORS configuration**: Added support for both localhost and 127.0.0.1

### Architecture Validated
```
Frontend (localhost:3000)
    â†“
Backend (localhost:8000)
    â†“
TickTick API (api.ticktick.com) + Ollama (127.0.0.1:11434)
    â†“
PostgreSQL (port 5433)
```

**Database State:**
- 1 User with TickTick OAuth tokens
- 60 Tasks with complete AI analysis:
  - urgency_score (1-10)
  - importance_score (1-10)
  - eisenhower_quadrant (Q1/Q2/Q3/Q4)
  - analysis_reasoning (AI explanation)
  - ticktick_task_id, ticktick_project_id

**Git Commits:**
- `e926e75` - Initial Phase 2 implementation
- `bec2b52` - OAuth flow and database fixes

**Ready for Phase 3:**
- All 60 tasks are synced and analyzed
- Task list API ready (`GET /api/tasks` with filters)
- Next: Display tasks in "My Tasks" tab with quadrant filtering

### Backend Changes

**New Files:**
```
backend/app/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py               # Environment variables (pydantic-settings)
â”‚   â””â”€â”€ database.py             # PostgreSQL async setup
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ task.py                 # Task model
â”œâ”€â”€ services/
â”‚   â””â”€â”€ ticktick.py             # TickTick API client
â””â”€â”€ api/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ tasks.py                # Task CRUD endpoints
    â””â”€â”€ auth.py                 # TickTick OAuth endpoints
```

**Database:** PostgreSQL via Docker (already running from Iteration 0)

**Task Model:**
- id, ticktick_id, title, description
- urgency, importance, quadrant, reasoning
- created_at, updated_at

**TickTick Service:**
- Full OAuth flow (you have Client ID + Secret)
- Authorization URL â†’ Callback â†’ Token exchange
- `GET /task` - Fetch all tasks
- Map to internal Task model

**New Endpoints:**
- `GET /api/auth/ticktick` - Redirect to TickTick OAuth
- `GET /api/auth/ticktick/callback` - Handle OAuth callback
- `POST /api/tasks/sync` - Fetch from TickTick, analyze, store
- `GET /api/tasks` - List all analyzed tasks
- `GET /api/tasks/{id}` - Get single task

### Frontend Changes

**New Component: TaskList.tsx**
- "Sync TickTick" button
- List of tasks with quadrant badges
- Urgency/importance scores
- Reasoning preview

**Update page.tsx:**
- Tab navigation: Analyze | My Tasks | Settings

### What's Deferred
- Bi-directional sync (read-only for now)
- Webhooks (polling first)
- Background jobs (Celery)
- Matrix visualization (list view first)

### Success Criteria - âœ… ALL MET (2025-12-10)
- âœ… Real TickTick tasks sync successfully (60 tasks)
- âœ… Analysis completes efficiently (60 tasks analyzed)
- âœ… Tasks persist in PostgreSQL with full metadata
- âœ… Can refresh and see synced tasks (stored in database)

---

## Iteration 3: Task List View (3-4 hours)

**Goal:** Display synced tasks in a list view with AI analysis results

**Demo:** Navigate to "My Tasks" tab â†’ see all 60 tasks organized by Eisenhower quadrant

**Status:** âœ… **COMPLETED** (2025-12-10 - List view + Eisenhower Matrix with popovers working)

### Frontend Changes

**New Components:**
```
frontend/components/
â”œâ”€â”€ TaskList.tsx           # Main list view with filters
â”œâ”€â”€ TaskCard.tsx           # Individual task display
â””â”€â”€ QuadrantFilter.tsx     # Optional: Q1/Q2/Q3/Q4 filter tabs
```

**Component Requirements:**

**TaskList.tsx:**
- Fetch tasks from `GET /api/tasks?user_id=1`
- Display in responsive grid (1 col mobile, 2 tablet, 3 desktop)
- Quadrant filtering (All, Q1, Q2, Q3, Q4)
- Loading states with skeleton
- Empty state if no tasks
- Task count badges per quadrant

**TaskCard.tsx:**
- Title and description (truncated)
- Quadrant badge with color coding:
  - Q1: Red (`bg-red-900/50 border-red-700`)
  - Q2: Green (`bg-green-900/50 border-green-700`)
  - Q3: Yellow (`bg-yellow-900/50 border-yellow-700`)
  - Q4: Blue (`bg-blue-900/50 border-blue-700`)
- Urgency/importance progress bars
- AI reasoning (collapsible)
- TickTick metadata (optional)

**Update page.tsx:**
- Add "My Tasks" tab (between Analyze and Settings)
- Wire up TaskList component

### Backend Changes (Minimal)

**Existing endpoints are sufficient:**
- `GET /api/tasks?user_id=1&quadrant=Q1&status=active` - Already implemented
- No new endpoints needed!

**Optional additions:**
- `GET /api/tasks/stats` - Return counts per quadrant (nice-to-have)

### What's Deferred
- Task detail modal/page (basic card view first)
- Task editing/completion (read-only for now)
- Real-time updates (manual refresh first)
- Eisenhower matrix visualization (list view first)

### Completed Work (2025-12-10)

**Components Created:**
- âœ… `TaskCard.tsx` - Individual task display with quadrant badges, urgency/importance progress bars, expandable AI reasoning
- âœ… `TaskList.tsx` - Main list view with Matrix/List toggle, quadrant filtering, refresh functionality
- âœ… `QuadrantFilter.tsx` - Quadrant filter tabs with task counts (Q1/Q2/Q3/Q4)
- âœ… `EisenhowerMatrix.tsx` - 2x2 matrix view with task popovers

**Features Implemented:**
- âœ… **Dual View System:** Toggle between Matrix and List views
- âœ… **Eisenhower Matrix View:** 4-quadrant layout with color-coded cards
  - Q1 (Red): 16 tasks - Urgent & Important
  - Q2 (Green): 24 tasks - Not Urgent, Important
  - Q3 (Yellow): 2 tasks - Urgent, Not Important
  - Q4 (Blue): 18 tasks - Neither
- âœ… **Task Popovers:** Click any task in Matrix view to see detailed info in popover
- âœ… **List View:** Grid layout with quadrant filtering (All/Q1/Q2/Q3/Q4)
- âœ… **Task Cards:** Show title, description, urgency/importance scores, AI reasoning
- âœ… **Responsive Design:** 1 col mobile, 2 tablet, 3 desktop
- âœ… **Loading States:** Skeleton loaders during data fetch
- âœ… **Error Handling:** Clear error messages with retry button

**UI Components Used:**
- shadcn/ui: Card, Badge, Progress, Popover, Tabs, Button, Skeleton, Alert

**Testing:**
- âœ… All 60 tasks display correctly in both views
- âœ… Matrix view shows proper quadrant distribution
- âœ… Popovers open on task click with full details
- âœ… List view filtering works for all quadrants
- âœ… Refresh button updates task list
- âœ… Responsive layout tested on different screen sizes

### Success Criteria - âœ… ALL MET (2025-12-10)
- âœ… All 60 synced tasks display correctly
- âœ… Tasks organized by Eisenhower quadrant
- âœ… Color-coded quadrant badges
- âœ… Urgency/importance scores visible with progress bars
- âœ… AI reasoning readable (expandable in cards, full in popovers)
- âœ… Responsive layout (mobile/tablet/desktop)
- âœ… Quadrant filtering works in List view
- âœ… Eisenhower Matrix view with interactive popovers
- âœ… Playwright E2E tests pass

### Files Modified/Created
**New Components:**
- `frontend/components/TaskCard.tsx`
- `frontend/components/TaskList.tsx`
- `frontend/components/QuadrantFilter.tsx`
- `frontend/components/EisenhowerMatrix.tsx`

**New UI Components (shadcn):**
- `frontend/components/ui/badge.tsx`
- `frontend/components/ui/progress.tsx`
- `frontend/components/ui/popover.tsx`
- `frontend/components/ui/skeleton.tsx`

**Modified:**
- `frontend/app/page.tsx` - Added "My Tasks" tab
- `docs/Plan1-2025-12-09.md` - Updated with Phase 3 completion

**Git Commit:**
```
01b3bcf - feat: implement Phase 3 - Task List View with Eisenhower Matrix
```

---

## Phase Summary (Iterations 0-3)

### What's Working âœ…
1. **Backend Infrastructure**
   - FastAPI server with task analysis, CRUD, sync endpoints
   - PostgreSQL database with 60 real tasks + AI analysis
   - TickTick OAuth integration (full sync working)
   - Ollama qwen3:4b for local AI task analysis

2. **Frontend Application**
   - Next.js 14 with TypeScript + Tailwind
   - Three tabs: Analyze Task | My Tasks | Settings
   - Dual view system: Eisenhower Matrix + List views
   - Real-time task display with AI insights
   - Responsive design (mobile/tablet/desktop)

3. **AI Analysis Pipeline**
   - 60/60 tasks analyzed successfully
   - Urgency scores (1-10), Importance scores (1-10)
   - Eisenhower quadrant assignment (Q1/Q2/Q3/Q4)
   - Natural language reasoning for each decision

4. **User Experience**
   - Click any task â†’ see detailed popover
   - Filter by quadrant in List view
   - Visual matrix in Matrix view
   - Manual task analysis in Analyze tab
   - TickTick connection management in Settings

### Current Database State
- **1 User** with TickTick OAuth tokens
- **60 Tasks** fully analyzed:
  - Q1 (Urgent & Important): 16 tasks
  - Q2 (Not Urgent, Important): 24 tasks
  - Q3 (Urgent, Not Important): 2 tasks
  - Q4 (Neither): 18 tasks

### What's Next (Iteration 4+)
- Multiple LLM provider support (Gemini, OpenRouter)
- Task editing/completion in UI
- Real-time sync with webhooks
- Calendar integration for Q1/Q2 scheduling
- Advanced analytics dashboard

---

## Iteration 4: Multiple LLM Providers + Polish (3-4 hours)

**Goal:** Support Ollama, Gemini, OpenRouter with provider selection UI

**Demo:** Switch between providers, compare accuracy and speed

### Backend Changes

**New Files:**
```
backend/app/services/
â”œâ”€â”€ llm/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py                 # Abstract base class
â”‚   â”œâ”€â”€ factory.py              # Provider factory
â”‚   â”œâ”€â”€ ollama.py               # Ollama (moved)
â”‚   â”œâ”€â”€ gemini.py               # Google Gemini
â”‚   â””â”€â”€ openrouter.py           # OpenRouter (DeepSeek, etc.)
```

**Provider Interface (base.py):**
```python
class LLMProvider(ABC):
    async def analyze_task(self, description: str) -> TaskAnalysis
    async def health_check(self) -> bool
```

**Factory (factory.py):**
- Get provider by name
- Health check before use
- Fallback logic (optional)

**New Dependencies:**
```
google-generativeai==0.3.2
```

**Environment Variables:**
```
LLM_PROVIDER=ollama
OLLAMA_URL=http://localhost:11434
OLLAMA_MODEL=llama3.1:8b
GEMINI_API_KEY=...
OPENROUTER_API_KEY=...
OPENROUTER_MODEL=deepseek/deepseek-chat
```

### Frontend Changes

**Enhanced LLMSettings.tsx:**
- Provider selector: Ollama | Gemini | OpenRouter
- Provider-specific config fields
- Model dropdown per provider
- Connection status indicator
- Save to backend (new endpoint)

**New Endpoint:**
- `GET /api/settings` - Get current LLM config
- `PUT /api/settings` - Update LLM config
- Store in SQLite settings table

### What's Deferred
- Provider-specific prompts
- Cost tracking
- Rate limiting
- User accounts

### Success Criteria
- All 3 providers work
- Can switch without restart
- Settings persist in database
- Clear status indicators

---

## File Creation Order

### Iteration 0 (Backend MVP)
1. `backend/requirements.txt`
2. `backend/.env.example`
3. `backend/app/__init__.py`
4. `backend/app/main.py`
5. `backend/app/services/__init__.py`
6. `backend/app/services/llm_ollama.py`

### Iteration 1 (Frontend MVP)
7. `frontend/package.json`
8. `frontend/next.config.js`
9. `frontend/tsconfig.json`
10. `frontend/tailwind.config.ts`
11. `frontend/postcss.config.js`
12. `frontend/src/app/globals.css`
13. `frontend/src/app/layout.tsx`
14. `frontend/src/app/page.tsx`
15. `frontend/src/lib/api.ts`
16. `frontend/src/components/TaskAnalyzer.tsx`
17. `frontend/src/components/LLMSettings.tsx`
18. `frontend/src/app/settings/page.tsx`

### Iteration 2 (TickTick)
19. `backend/app/core/__init__.py`
20. `backend/app/core/config.py`
21. `backend/app/core/database.py`
22. `backend/app/models/__init__.py`
23. `backend/app/models/task.py`
24. `backend/app/services/ticktick.py`
25. `backend/app/api/__init__.py`
26. `backend/app/api/tasks.py`
27. `frontend/src/components/TaskList.tsx`

### Iteration 3 (Multi-Provider)
28. `backend/app/services/llm/__init__.py`
29. `backend/app/services/llm/base.py`
30. `backend/app/services/llm/factory.py`
31. `backend/app/services/llm/ollama.py` (refactored)
32. `backend/app/services/llm/gemini.py`
33. `backend/app/services/llm/openrouter.py`
34. `backend/app/models/settings.py`
35. `backend/app/api/settings.py`

---

## Testing Strategy

### Iteration 0
```bash
# Terminal 1: Start Docker services
docker-compose up -d

# Terminal 2: Ensure Ollama is running with qwen3
ollama run qwen3:4b

# Terminal 3: Start backend
cd backend
python -m venv venv && source venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8000

# Test
curl -X POST http://localhost:8000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{"description": "Finish quarterly report by Friday"}'
```

### Iteration 1
```bash
# Terminal 4: Start frontend
cd frontend
npm install
npm run dev

# Visit http://localhost:3000
# Type task, click Analyze
# Go to Settings, verify Ollama connection
```

### Iteration 2
```bash
# Add TickTick credentials to .env
TICKTICK_CLIENT_ID=your_client_id
TICKTICK_CLIENT_SECRET=your_client_secret

# In UI: Click "Connect TickTick" â†’ OAuth flow
# Click "Sync" â†’ Verify tasks appear with analysis
```

---

## Decision Points

After each iteration, evaluate:

1. **Accuracy:** Do quadrant assignments match intuition?
2. **Speed:** Is analysis fast enough (<5s for single task)?
3. **Usability:** Would you use this daily?

**If NO to any:**
- Iteration 0: Try `qwen3:8b` for better accuracy, or add Gemini
- Iteration 1: Simplify UI further
- Iteration 2: Check if TickTick integration adds value
